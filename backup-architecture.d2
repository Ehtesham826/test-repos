# Backup Architecture Diagram
# SCP Infrastructure

title: {
  label: SCP Backup Architecture
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

# Kubernetes Cluster
cluster: {
  label: Kubernetes Cluster
  style: {
    fill: "#e8f4f8"
    stroke: "#2980b9"
  }

  sol: {
    label: SOL\n(Master #1)
    shape: rectangle
    style: {
      fill: "#3498db"
      font-color: white
    }
  }

  terra: {
    label: TERRA\n(Master #2)
    shape: rectangle
    style: {
      fill: "#3498db"
      font-color: white
    }
  }

  luna: {
    label: LUNA\n(GPU Worker)
    shape: rectangle
    style: {
      fill: "#9b59b6"
      font-color: white
    }
  }

  pluto: {
    label: PLUTO\n(GPU Worker)
    shape: rectangle
    style: {
      fill: "#9b59b6"
      font-color: white
    }
  }

  velero: {
    label: Velero\n(Backup Controller)
    shape: hexagon
    style: {
      fill: "#27ae60"
      font-color: white
    }
  }

  longhorn: {
    label: Longhorn\n(Storage)
    shape: hexagon
    style: {
      fill: "#e67e22"
      font-color: white
    }
  }

  etcd: {
    label: etcd\n(Cluster State)
    shape: cylinder
    style: {
      fill: "#34495e"
      font-color: white
    }
  }

  databases: {
    label: Databases\n(PostgreSQL, Redis, Qdrant)
    shape: cylinder
    style: {
      fill: "#8e44ad"
      font-color: white
    }
  }
}

# NAS Storage
nas: {
  label: NAS Storage\n10.10.30.50\n(Primary Backup Target)
  style: {
    fill: "#fff3cd"
    stroke: "#856404"
  }

  velero_backups: {
    label: /velero-backups\nK8s Resources
    shape: cylinder
    style: {
      fill: "#ffc107"
    }
  }

  longhorn_backups: {
    label: /longhorn-backups\nPersistent Volumes
    shape: cylinder
    style: {
      fill: "#ffc107"
    }
  }

  etcd_backups: {
    label: /etcd-backups\nCluster State
    shape: cylinder
    style: {
      fill: "#ffc107"
    }
  }

  db_backups: {
    label: /database-backups\nPostgreSQL, Redis
    shape: cylinder
    style: {
      fill: "#ffc107"
    }
  }
}

# Backup Flows
cluster.velero -> nas.velero_backups: {
  label: Daily 2:00 AM\n30 day retention
  style: {
    stroke: "#27ae60"
    stroke-width: 2
  }
}

cluster.longhorn -> nas.longhorn_backups: {
  label: Every 6 hours\n7 day retention
  style: {
    stroke: "#e67e22"
    stroke-width: 2
  }
}

cluster.etcd -> nas.etcd_backups: {
  label: Every 12 hours\n7 day retention
  style: {
    stroke: "#34495e"
    stroke-width: 2
  }
}

cluster.databases -> nas.db_backups: {
  label: Daily 1:00 AM\n30 day retention
  style: {
    stroke: "#8e44ad"
    stroke-width: 2
  }
}

# Retention Policy Box
retention: {
  label: Retention Policies
  style: {
    fill: "#f8f9fa"
    stroke: "#6c757d"
  }

  policy: {
    label: |md
      | Backup Type | Frequency | Retention |
      |-------------|-----------|-----------|
      | Full Cluster (Velero) | Daily 2:00 AM | 30 days |
      | PV Snapshots (Longhorn) | Every 6 hours | 7 days |
      | etcd Snapshots | Every 12 hours | 7 days |
      | Database Dumps | Daily 1:00 AM | 30 days |
    |
    shape: rectangle
    style: {
      fill: white
    }
  }
}

# Restore Flow Box
restore: {
  label: Restore Procedures
  style: {
    fill: "#d4edda"
    stroke: "#155724"
  }

  procedures: {
    label: |md
      **Full Cluster Restore**
      velero restore create --from-backup <backup-name>

      **Single Namespace Restore**
      velero restore create --from-backup <backup> --include-namespaces <ns>

      **Volume Restore**
      Longhorn UI > Backup > Restore

      **etcd Restore**
      rke2 server --cluster-reset --cluster-reset-restore-path=<snapshot>

      **Database Restore**
      psql < backup.sql
    |
    shape: rectangle
    style: {
      fill: white
    }
  }
}

# Layout
nas -> retention: {style.opacity: 0}
retention -> restore: {style.opacity: 0}
